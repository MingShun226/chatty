{
  "name": "WhatsApp Chatbot - Wendy (API Tools)",
  "nodes": [
    {
      "parameters": {
        "jsCode": "// Extract WhatsApp webhook data and prepare for AI Agent\n// NOTE: Products and knowledge base are NOT in webhook anymore\n// AI Agent must fetch them via API tools\n\nconst inputData = $input.first().json;\n\nconsole.log('=== WhatsApp Webhook Data ===');\nconsole.log('Keys received:', Object.keys(inputData));\n\n// Extract main fields\nconst message = inputData.message || inputData.body?.message || 'Hello';\nconst fromNumber = inputData.from_number || inputData.body?.from_number || 'unknown';\nconst chatbot = inputData.chatbot || inputData.body?.chatbot || {};\nconst api = inputData.api || inputData.body?.api || {};\n\n// Check if this was an analyzed media message\nconst mediaType = inputData.media_type || 'text';\nconst wasAnalyzed = inputData.analysis_performed || false;\nconst originalMessage = inputData.original_message || null;\n\nconsole.log('Message:', message.substring(0, 100));\nconsole.log('From:', fromNumber);\nconsole.log('Chatbot:', chatbot.name);\nconsole.log('Chatbot ID:', chatbot.id);\nconsole.log('Media Type:', mediaType);\nconsole.log('API Base URL:', api.base_url);\n\n// Create contact object for session\nconst contact = {\n  id: fromNumber.replace(/[^0-9]/g, ''),\n  phone: fromNumber,\n  name: fromNumber\n};\n\n// Enhanced message with media context\nlet enhancedMessage = message;\nif (wasAnalyzed && mediaType !== 'text') {\n  const mediaTypeLabel = {\n    'image': 'Image',\n    'audio': 'Audio',\n    'video': 'Video',\n    'document': 'Document'\n  }[mediaType] || 'Media';\n  \n  enhancedMessage = `[${mediaTypeLabel} Analysis]\\n${message}`;\n  \n  if (originalMessage && originalMessage !== '[Media file]') {\n    enhancedMessage += `\\n\\n[User's caption: ${originalMessage}]`;\n  }\n}\n\n// Return formatted data for AI Agent\nreturn {\n  json: {\n    // AI Agent expects chatInput field\n    chatInput: enhancedMessage,\n\n    // Contact info for session management\n    contact: contact,\n    phone: fromNumber,\n\n    // Chatbot configuration\n    chatbotConfig: {\n      id: chatbot.id,\n      name: chatbot.name || 'Assistant',\n      company: chatbot.company_name || '',\n      industry: chatbot.industry || '',\n      systemPrompt: chatbot.system_prompt || 'You are a helpful AI assistant.',\n      businessContext: chatbot.business_context || '',\n      complianceRules: chatbot.compliance_rules || [],\n      responseGuidelines: chatbot.response_guidelines || [],\n      promptVersion: chatbot.prompt_version || null\n    },\n\n    // API configuration for tools\n    apiConfig: {\n      baseUrl: api.base_url || 'https://xatrtqdgghanwdujyhkq.supabase.co/functions/v1',\n      chatbotId: chatbot.id\n    },\n\n    // Metadata\n    timestamp: new Date().toISOString(),\n    messageType: mediaType,\n    wasMediaAnalyzed: wasAnalyzed,\n    sessionId: `whatsapp_${contact.id}_${Date.now()}`,\n\n    // Debug\n    debug: {\n      mediaType: mediaType,\n      wasAnalyzed: wasAnalyzed,\n      source: 'whatsapp_webhook',\n      chatbotId: chatbot.id,\n      promptVersion: chatbot.prompt_version\n    }\n  }\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        7344,
        688
      ],
      "id": "e1a0dcaf-dbc9-4747-bda1-d54b2f90c23c",
      "name": "Extract WhatsApp Data"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "chatInput",
              "name": "chatInput",
              "value": "={{ $json.chatInput }}",
              "type": "string"
            },
            {
              "id": "systemPrompt",
              "name": "systemPrompt",
              "value": "={{ $json.chatbotConfig.systemPrompt }}",
              "type": "string"
            },
            {
              "id": "businessContext",
              "name": "businessContext",
              "value": "={{ $json.chatbotConfig.businessContext }}",
              "type": "string"
            },
            {
              "id": "chatbotId",
              "name": "chatbotId",
              "value": "={{ $json.chatbotConfig.id }}",
              "type": "string"
            }
          ]
        },
        "includeOtherFields": true,
        "options": {}
      },
      "id": "199c6429-28d3-437b-9c4f-3b40c56a8fab",
      "name": "Workflow Configuration",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        7568,
        688
      ]
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "={{ $json.chatInput }}",
        "options": {
          "systemMessage": "=Current date and time: {{ $now.toISO() }}\nToday in Malaysia: {{ $now.setZone('Asia/Kuala_Lumpur').toFormat('yyyy-MM-dd HH:mm') }}\n\n{{ $json.systemPrompt }}\n\nðŸ¢ BUSINESS CONTEXT:\n{{ $json.businessContext }}\n\n{{ $json.chatbotConfig?.complianceRules?.length > 0 ? 'âš ï¸ COMPLIANCE RULES:\\n' + $json.chatbotConfig.complianceRules.map(r => '- ' + r).join('\\n') : '' }}\n\n{{ $json.chatbotConfig?.responseGuidelines?.length > 0 ? 'âœ… RESPONSE GUIDELINES:\\n' + $json.chatbotConfig.responseGuidelines.map(g => '- ' + g).join('\\n') : '' }}\n\nðŸ’¬ CONVERSATION CONTEXT:\nPrevious messages are tracked automatically via memory. Do not repeat answering same questions.\n\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\nðŸ”§ API TOOLS - WHEN TO USE EACH TOOL\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\nYou have access to these tools. USE THEM when relevant:\n\nðŸ“¦ **search_product** - Search product catalog\n   USE WHEN:\n   âœ… Customer asks about products, prices, stock\n   âœ… \"Do you have iPhone?\", \"Show me laptops\", \"What's in stock?\"\n   âœ… \"How much is...\", \"Is there any...\"\n   âœ… Customer mentions a product name or category\n   HOW: Pass a search term to find matching products\n   RETURNS: Product name, price, description, stock, image_url\n\nðŸŽ **get_promotions** - Get active promotions\n   USE WHEN:\n   âœ… Customer asks about discounts, offers, sales\n   âœ… \"Any promotions?\", \"Do you have discount?\"\n   âœ… \"What's on sale?\", \"Any special offers?\"\n   HOW: Just call it - no parameters needed\n   RETURNS: List of active promotions with discount details\n\nâœ… **validate_promo** - Validate a promo code\n   USE WHEN:\n   âœ… Customer gives you a promo code to check\n   âœ… \"Is code ABC123 valid?\", \"Can I use SAVE20?\"\n   âœ… \"Check this promo code for me\"\n   HOW: Pass the promo code to validate\n   RETURNS: Whether code is valid + discount details\n\nðŸ“š **get_knowledge** - Get knowledge base files and content\n   USE WHEN:\n   âœ… Customer asks questions about company, policies, procedures\n   âœ… \"What's your return policy?\", \"How do I...\", \"Tell me about...\"\n   âœ… Customer needs documentation or PDF files\n   âœ… Questions that need reference material to answer\n   HOW: Just call it - returns all files with download URLs and content chunks\n   RETURNS: Files with download_url + all text chunks grouped by file\n   IMPORTANT: If customer asks for a document, share the download_url from the response!\n\nðŸŒ **read_webpage** - Read content from a URL\n   USE WHEN:\n   âœ… Customer sends a link/URL\n   âœ… Customer asks to check a website\n   âœ… \"Look at this link\", \"Check this page\"\n   HOW: Pass the URL to read\n   RETURNS: Webpage content as text\n\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\nðŸ“± WHATSAPP MESSAGE FORMATTING RULES\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\nCRITICAL RULES:\n1. You are chatting via WhatsApp - keep responses concise and mobile-friendly\n2. Use \"||\" (double pipe) as delimiter between sentences to split messages\n3. NEVER use \\n\\n or double line breaks\n4. NEVER include image URLs or markdown in your reply text\n5. NEVER write ![Image](url) or [Image: url] in your reply\n6. Use emojis sparingly and only when appropriate\n7. If discussing products, USE the search_product tool first!\n8. If customer asks questions, USE the get_knowledge tool first!\n9. Follow ALL compliance rules strictly\n10. Be helpful, professional, and friendly\n11. **Do not repeat same thing within few conversations - check memory!**\n\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\nðŸ“¤ RESPONSE FORMAT (STRICT JSON ONLY)\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\nYou MUST respond in this EXACT JSON format:\n\n{\n  \"reply\": \"Your text response using || as delimiter\",\n  \"images\": [],\n  \"documents\": []\n}\n\nðŸš« WHAT NOT TO DO IN REPLY:\n- âŒ Don't write: \"Here's the product: https://storage.com/image.jpg\"\n- âŒ Don't write: \"![Product Name](https://storage.com/image.jpg)\"\n- âŒ Don't write: \"[Image: https://storage.com/image.jpg]\"\n- âŒ Don't use \\n\\n or double line breaks\n- âŒ Don't include any URLs in the reply text\n\nâœ… WHAT TO DO IN REPLY:\n- âœ… Use || to separate sentences: \"Sentence 1 || Sentence 2 || Sentence 3\"\n- âœ… Keep reply as clean text only - no URLs, no markdown\n- âœ… Put image URLs in the separate \"images\" array\n- âœ… Describe the product in words, then add image URL to images array\n\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\nðŸ“¸ HOW TO USE PRODUCT IMAGES\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\nWhen search_product returns products with image_url:\n1. Describe the product in your reply text\n2. Add the image_url to the images array\n\nExample response after calling search_product:\n{\n  \"reply\": \"Sure! || Here's the Samsung Galaxy S24 Ultra. It has a 200MP camera and 6.8-inch display. || Price is RM 5299.\",\n  \"images\": [\n    {\n      \"url\": \"https://storage.supabase.co/.../samsung.jpg\",\n      \"caption\": \"Samsung Galaxy S24 Ultra - RM 5299\"\n    }\n  ],\n  \"documents\": []\n}\n\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\nðŸ“„ HOW TO SEND DOCUMENTS\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\nWhen get_knowledge returns files with download_url:\n1. Answer the question using the chunk content\n2. If customer wants the actual document, add it to documents array\n\nExample response after calling get_knowledge:\n{\n  \"reply\": \"Our return policy allows returns within 14 days. || I'm sending you the full policy document.\",\n  \"images\": [],\n  \"documents\": [\n    {\n      \"url\": \"https://storage.supabase.co/.../Return_Policy.pdf\",\n      \"fileName\": \"Return Policy.pdf\",\n      \"caption\": \"Return Policy Document\"\n    }\n  ]\n}\n\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\nâœ… COMPLETE EXAMPLES\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\nExample 1: Customer asks about a product\nCustomer: \"Do you have iPhone 15?\"\nâ†’ Call search_product with query \"iPhone 15\"\nâ†’ Use the returned data to respond:\n{\n  \"reply\": \"Yes! We have the iPhone 15 Pro Max in stock. || It's priced at RM 6499 with 256GB storage. || Would you like to see it?\",\n  \"images\": [\n    {\"url\": \"https://..../iphone15.jpg\", \"caption\": \"iPhone 15 Pro Max - RM 6499\"}\n  ],\n  \"documents\": []\n}\n\nExample 2: Customer asks about promotions\nCustomer: \"Any discounts?\"\nâ†’ Call get_promotions\nâ†’ Use the returned promotions:\n{\n  \"reply\": \"Yes! We have some great deals right now! || 10% off all iPhones with code APPLE10. || Buy 2 accessories get 1 free. || Which interests you?\",\n  \"images\": [],\n  \"documents\": []\n}\n\nExample 3: Customer wants to validate promo code\nCustomer: \"Is SAVE20 valid?\"\nâ†’ Call validate_promo with promo_code \"SAVE20\"\nâ†’ Respond based on result:\n{\n  \"reply\": \"Yes! SAVE20 is valid! || You get 20% off, up to RM 100. || Valid until end of January.\",\n  \"images\": [],\n  \"documents\": []\n}\n\nExample 4: Customer asks about policies\nCustomer: \"What's your warranty policy?\"\nâ†’ Call get_knowledge\nâ†’ Search through chunks for warranty info\nâ†’ If PDF exists, offer to send:\n{\n  \"reply\": \"We offer 1 year warranty on all electronics. || Covers manufacturing defects. || Want me to send you the full warranty document?\",\n  \"images\": [],\n  \"documents\": []\n}\n\nIf customer says yes:\n{\n  \"reply\": \"Here's the warranty policy document!\",\n  \"images\": [],\n  \"documents\": [\n    {\"url\": \"https://.../warranty.pdf\", \"fileName\": \"Warranty Policy.pdf\", \"caption\": \"Full Warranty Terms\"}\n  ]\n}\n\nExample 5: Simple text reply (no tools needed)\n{\n  \"reply\": \"We're open Monday to Friday, 9 AM to 6 PM. || Our store is at KL City Center.\",\n  \"images\": [],\n  \"documents\": []\n}\n\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\nðŸŽ¯ WHEN TO INCLUDE IMAGES\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\nInclude images when customer:\nâœ… Asks to \"see\" or \"show me\" a product\nâœ… Asks \"do you have image of...\"\nâœ… Asks about product appearance, colors, or design\nâœ… Says \"let me see the...\" or \"can I view...\"\n\nDon't include images when customer:\nâŒ Only asks about price, specs, or availability\nâŒ Asks general questions like \"what products do you have?\"\nâŒ Just wants text information\n\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\nðŸ”„ TOOL USAGE FLOW\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\n1. Customer sends message\n2. Determine which tool(s) to use based on the message\n3. Call the appropriate tool(s)\n4. Use the returned data to craft your response\n5. Format response as JSON with reply, images, documents\n\nIMPORTANT:\n- Products are NOT pre-loaded - you MUST use search_product tool\n- Knowledge is NOT pre-loaded - you MUST use get_knowledge tool\n- Always use tools when customer asks about products, promotions, or policies\n- The tools give you real-time data from the database\n\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\nNow respond to the customer's message in the correct JSON format.\n"
        }
      },
      "id": "d0e46e47-4ee9-4d6e-81d1-a830f6506368",
      "name": "AI Agent",
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 1.8,
      "position": [
        7968,
        688
      ]
    },
    {
      "parameters": {
        "model": {
          "__rl": true,
          "value": "gpt-4o-mini",
          "mode": "list",
          "cachedResultName": "gpt-4o-mini"
        },
        "builtInTools": {},
        "options": {}
      },
      "id": "1b1d17f2-1f07-4c25-8941-69b168ecb897",
      "name": "OpenAI Chat Model",
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
      "typeVersion": 1.3,
      "position": [
        7680,
        928
      ],
      "credentials": {
        "openAiApi": {
          "id": "5HLXljL3CNZANdI4",
          "name": "OpenAi account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Format AI Agent output for WhatsApp webhook response\nconst inputData = $input.first().json;\n\nconsole.log('=== Formatting AI Response ===');\nconsole.log('Input keys:', Object.keys(inputData));\n\n// Extract AI response - try multiple possible fields\nlet aiResponse = '';\n\nif (inputData.output) {\n  aiResponse = inputData.output;\n} else if (inputData.text) {\n  aiResponse = inputData.text;\n} else if (inputData.response) {\n  aiResponse = inputData.response;\n} else if (inputData.content) {\n  aiResponse = inputData.content;\n} else if (typeof inputData === 'string') {\n  aiResponse = inputData;\n} else {\n  // Fallback: stringify the whole object\n  aiResponse = 'I\\'m sorry, I\\'m having trouble generating a response right now. Please try again.';\n  console.log('Warning: Could not extract AI response from:', inputData);\n}\n\n// Clean up response\naiResponse = String(aiResponse).trim();\n\nconsole.log('Raw AI Response:', aiResponse.substring(0, 200) + '...');\n\n// Try to parse as JSON if it looks like JSON\nlet reply = aiResponse;\nlet images = [];\nlet documents = [];\n\nif (aiResponse.startsWith('{') || aiResponse.startsWith('[')) {\n  try {\n    const parsed = JSON.parse(aiResponse);\n    console.log('Successfully parsed AI response as JSON');\n\n    // Extract reply, images, and documents from parsed JSON\n    reply = parsed.reply || parsed.response || parsed.message || parsed.text || aiResponse;\n    images = parsed.images || [];\n    documents = parsed.documents || [];\n\n    console.log('Extracted reply:', reply.substring(0, 100));\n    console.log('Extracted images:', images.length, 'image(s)');\n    console.log('Extracted documents:', documents.length, 'document(s)');\n  } catch (e) {\n    console.log('AI response is not valid JSON, using as-is');\n    // Not JSON, use the raw response\n  }\n}\n\n// Return in the format expected by WhatsApp service\nreturn {\n  json: {\n    reply: reply,\n    images: images,\n    documents: documents\n  }\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        8368,
        688
      ],
      "id": "9d0dd695-bd90-4b83-bd70-1b0e72fe8ba1",
      "name": "Format for WhatsApp"
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ $('Format for WhatsApp').first().json }}",
        "options": {}
      },
      "id": "6f582a21-8dd3-4134-a2d9-160f15d44d81",
      "name": "Respond to Webhook",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1,
      "position": [
        8624,
        688
      ]
    },
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "059f167c-8fb7-480d-b6cd-2119d12948c4",
        "responseMode": "responseNode",
        "options": {}
      },
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2.1,
      "position": [
        5328,
        688
      ],
      "id": "105db5d1-5a43-4235-8642-1362b98fa692",
      "name": "Webhook",
      "webhookId": "059f167c-8fb7-480d-b6cd-2119d12948c4"
    },
    {
      "parameters": {
        "resource": "image",
        "operation": "analyze",
        "modelId": {
          "__rl": true,
          "value": "gpt-4o-mini",
          "mode": "list",
          "cachedResultName": "GPT-4O-MINI"
        },
        "imageUrls": "={{ $json.body.media.url }}",
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.openAi",
      "typeVersion": 2.1,
      "position": [
        6272,
        352
      ],
      "id": "fb0e2bea-858e-41a5-b504-0804bcd25989",
      "name": "Analyze image",
      "credentials": {
        "openAiApi": {
          "id": "5HLXljL3CNZANdI4",
          "name": "OpenAi account"
        }
      }
    },
    {
      "parameters": {
        "resource": "audio",
        "operation": "transcribe",
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.openAi",
      "typeVersion": 2.1,
      "position": [
        6352,
        576
      ],
      "id": "3ce16d85-154b-4a7d-bec3-ff9a226197b0",
      "name": "Transcribe a recording",
      "credentials": {
        "openAiApi": {
          "id": "5HLXljL3CNZANdI4",
          "name": "OpenAi account"
        }
      }
    },
    {
      "parameters": {
        "url": "={{ $json.body.media.url }}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        6144,
        576
      ],
      "id": "04a19f55-9c59-4948-8e48-38fdbdc8f962",
      "name": "Get Audio"
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 3
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.body.media.type }}",
                    "rightValue": "image",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "dac09a4c-6daf-4716-b871-6f274bc5fc95"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Image"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 3
                },
                "conditions": [
                  {
                    "id": "38ff055a-6853-4380-a44a-d9d64f305f12",
                    "leftValue": "={{ $json.body.media.type }}",
                    "rightValue": "audio",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Audio"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 3
                },
                "conditions": [
                  {
                    "id": "3e246f55-68f6-4f0c-8242-a17c61bd60e4",
                    "leftValue": "={{ $json.body.message_type }}",
                    "rightValue": "text",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Text"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 3
                },
                "conditions": [
                  {
                    "id": "aa8d4a93-3ee4-4e8c-8bf9-8c9d55670578",
                    "leftValue": "={{ $json.body.media.type }}",
                    "rightValue": "document",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Document"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 3
                },
                "conditions": [
                  {
                    "id": "7ba29843-d39f-465d-92bf-734482758e44",
                    "leftValue": "={{ $json.body.media.type }}",
                    "rightValue": "video",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Video"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.4,
      "position": [
        5696,
        640
      ],
      "id": "14d84304-8d19-4215-bc7f-600e2bd504ef",
      "name": "Switch"
    },
    {
      "parameters": {
        "resource": "document",
        "modelId": {
          "__rl": true,
          "value": "models/gemini-2.5-flash",
          "mode": "list",
          "cachedResultName": "models/gemini-2.5-flash"
        },
        "documentUrls": "={{ $json.body.media.url }}",
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.googleGemini",
      "typeVersion": 1.1,
      "position": [
        6272,
        816
      ],
      "id": "1056780b-7704-465e-beb6-d51fe860bf45",
      "name": "Analyze document",
      "credentials": {
        "googlePalmApi": {
          "id": "OEh8Jh97ikKYtxpn",
          "name": "Google Gemini(PaLM) Api account"
        }
      }
    },
    {
      "parameters": {
        "resource": "video",
        "operation": "analyze",
        "modelId": {
          "__rl": true,
          "value": "models/gemini-2.5-flash",
          "mode": "list",
          "cachedResultName": "models/gemini-2.5-flash"
        },
        "videoUrls": "={{ $('Webhook').item.json.body.media.url }}",
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.googleGemini",
      "typeVersion": 1.1,
      "position": [
        6272,
        1024
      ],
      "id": "ac71f51f-041b-4437-bcfe-03fd08c882e4",
      "name": "Analyze video",
      "credentials": {
        "googlePalmApi": {
          "id": "OEh8Jh97ikKYtxpn",
          "name": "Google Gemini(PaLM) Api account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// FINAL FIX - Handles the correct OpenAI format: content[0].text\nconsole.log('=== Multi-Input Analysis Merge ===');\n\n// Get ALL inputs\nconst allInputs = $input.all();\nconsole.log('Total inputs received:', allInputs.length);\n\n// Helper function to extract analysis text\nfunction extractAnalysisText(data) {\n  // Handle array wrapper - unwrap it first\n  if (Array.isArray(data)) {\n    console.log('Input is array, unwrapping first item');\n    data = data[0];\n  }\n  \n  if (!data) return null;\n  \n  // OpenAI format: { content: [{ type: \"output_text\", text: \"...\" }] }\n  if (data.content && Array.isArray(data.content)) {\n    console.log('Found content array, length:', data.content.length);\n    const textParts = data.content.filter(item => item.text && item.text.length > 10);\n    if (textParts.length > 0) {\n      const text = textParts.map(item => item.text).join('\\n\\n');\n      console.log('âœ… Extracted from content array:', text.substring(0, 100));\n      return text;\n    }\n  }\n  \n  // OpenAI Analyze Image format: { annotations: [{ text: \"...\" }] }\n  if (data.annotations && Array.isArray(data.annotations)) {\n    console.log('Found annotations array, length:', data.annotations.length);\n    const textAnnotations = data.annotations.filter(a => a.text && a.text.length > 10);\n    if (textAnnotations.length > 0) {\n      const text = textAnnotations.map(a => a.text).join('\\n\\n');\n      console.log('âœ… Extracted from annotations:', text.substring(0, 100));\n      return text;\n    }\n  }\n  \n  // Gemini format: { content: { parts: [{ text: \"...\" }] } }\n  if (data.content && data.content.parts && Array.isArray(data.content.parts)) {\n    const parts = data.content.parts;\n    if (parts[0] && parts[0].text) {\n      console.log('âœ… Extracted from Gemini parts format');\n      return parts[0].text;\n    }\n  }\n  \n  // Alternative Gemini format: { candidates: [{ content: { parts: [...] } }] }\n  if (data.candidates && data.candidates[0] && data.candidates[0].content) {\n    const parts = data.candidates[0].content.parts;\n    if (parts && parts[0] && parts[0].text) {\n      console.log('âœ… Extracted from Gemini candidates format');\n      return parts[0].text;\n    }\n  }\n  \n  // OpenAI Whisper/Transcription: { text: \"...\" }\n  if (data.text && typeof data.text === 'string' && data.text.length > 10) {\n    console.log('âœ… Extracted from text field');\n    return data.text;\n  }\n  \n  // Message field\n  if (data.message && typeof data.message === 'string' && data.message.length > 10) {\n    console.log('âœ… Extracted from message field');\n    return data.message;\n  }\n  \n  // Direct string\n  if (typeof data === 'string' && data.length > 10) {\n    console.log('âœ… Direct string value');\n    return data;\n  }\n  \n  return null;\n}\n\n// Step 1: Find the analysis input\nlet analysisText = null;\n\nfor (let i = 0; i < allInputs.length; i++) {\n  const item = allInputs[i];\n  console.log(`Checking input ${i}...`);\n  \n  const extracted = extractAnalysisText(item.json);\n  if (extracted) {\n    analysisText = extracted;\n    console.log('âœ… Analysis found at input', i);\n    break;\n  }\n}\n\n// Step 2: Get webhook data\nlet webhookData = null;\ntry {\n  webhookData = $('Webhook').first().json;\n  console.log('âœ… Webhook accessed successfully');\n} catch (e) {\n  console.log('âš ï¸ Cannot access Webhook node:', e.message);\n  \n  // Fallback: look for webhook in inputs\n  for (const item of allInputs) {\n    const json = Array.isArray(item.json) ? item.json[0] : item.json;\n    if (json && json.body && json.body.from_number) {\n      webhookData = json;\n      console.log('âœ… Found webhook in inputs');\n      break;\n    }\n  }\n}\n\nif (!webhookData || !webhookData.body) {\n  throw new Error('âŒ No webhook data found - check Webhook node connection');\n}\n\nconst mediaType = webhookData.body?.media?.type || 'text';\nconsole.log('Media type:', mediaType);\n\n// Step 3: Determine final message\nlet finalMessage = '';\n\nif (analysisText) {\n  finalMessage = analysisText;\n  console.log('âœ… Using analysis text, length:', finalMessage.length);\n} else if (mediaType === 'text') {\n  // Text message - use original message\n  finalMessage = webhookData.body?.message || '';\n  console.log('âœ… Text message, using original');\n} else {\n  // Media but no analysis found\n  finalMessage = webhookData.body?.message || '[Media received - analysis unavailable]';\n  console.log('âš ï¸ No analysis found for media, using fallback');\n}\n\nconsole.log('=== Final Check ===');\nconsole.log('Message length:', finalMessage.length);\nconsole.log('Message preview:', finalMessage.substring(0, 100));\n\n// Step 4: Build output - NOTE: products and knowledge are NOT included\n// AI Agent must fetch them via API tools\nreturn {\n  json: {\n    body: webhookData.body,\n    message: finalMessage,\n    from_number: webhookData.body.from_number,\n    chatbot: webhookData.body.chatbot,\n    api: webhookData.body.api,\n    media_type: mediaType,\n    media_url: webhookData.body?.media?.url,\n    analysis_performed: mediaType !== 'text' && !!analysisText,\n    original_message: webhookData.body?.message || '[Media]'\n  }\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        7088,
        688
      ],
      "id": "202a42b4-3986-4458-9bc2-3d637d9803ff",
      "name": "Code in JavaScript"
    },
    {
      "parameters": {
        "sessionIdType": "customKey",
        "sessionKey": "={{ $json.contact.id }}",
        "tableName": "chat_history_wendy",
        "contextWindowLength": 50
      },
      "type": "@n8n/n8n-nodes-langchain.memoryPostgresChat",
      "typeVersion": 1.3,
      "position": [
        7856,
        928
      ],
      "id": "bb8bab26-dbfb-4184-8371-605a3330b337",
      "name": "Postgres Chat Memory",
      "credentials": {
        "postgres": {
          "id": "xNOp8yGL6Gc6SCWC",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "toolDescription": "Read content from a URL when customer sends a link. Use when customer shares any URL/link.",
        "url": "=https://r.jina.ai/{{ $fromAI('url', 'The URL to read', 'string') }}",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Accept",
              "value": "text/plain"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequestTool",
      "typeVersion": 4.3,
      "position": [
        8592,
        928
      ],
      "id": "4be1ad45-0b92-4d68-9b95-a3075e54d5d8",
      "name": "read_webpage"
    },
    {
      "parameters": {
        "toolDescription": "Search products in the catalog. Use when customer asks about products, prices, stock, or mentions any product name. Returns product details including name, price, description, stock quantity, and image_url.",
        "url": "https://xatrtqdgghanwdujyhkq.supabase.co/functions/v1/chatbot-data",
        "sendQuery": true,
        "queryParameters": {
          "parameters": [
            {
              "name": "type",
              "value": "products"
            },
            {
              "name": "chatbot_id",
              "value": "={{ $('Workflow Configuration').item.json.chatbotId }}"
            },
            {
              "name": "query",
              "value": "={{ $fromAI('query', 'Search term for products (e.g., iPhone, laptop, Samsung)', 'string') }}"
            },
            {
              "name": "limit",
              "value": "10"
            }
          ]
        },
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhhdHJ0cWRnZ2hhbndkdWp5aGtxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg5NjE1MzEsImV4cCI6MjA3NDUzNzUzMX0.sniz2dGyadAa3BvZJ2Omi6thtVWuqMjTFFdM1H_zWAA"
            },
            {
              "name": "x-api-key",
              "value": "pk_live_2e57d59f0802bb0c2e9b373aa7700efd4307a22590d17958aa50a1ac13119c61"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequestTool",
      "typeVersion": 4.3,
      "position": [
        8048,
        928
      ],
      "id": "f921f2eb-d410-4241-bc00-1628f095577b",
      "name": "search_product"
    },
    {
      "parameters": {
        "toolDescription": "Get all active promotions and discounts. Use when customer asks about offers, discounts, sales, or promotions. No parameters needed.",
        "url": "https://xatrtqdgghanwdujyhkq.supabase.co/functions/v1/chatbot-data",
        "sendQuery": true,
        "queryParameters": {
          "parameters": [
            {
              "name": "type",
              "value": "promotions"
            },
            {
              "name": "chatbot_id",
              "value": "={{ $('Workflow Configuration').item.json.chatbotId }}"
            }
          ]
        },
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhhdHJ0cWRnZ2hhbndkdWp5aGtxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg5NjE1MzEsImV4cCI6MjA3NDUzNzUzMX0.sniz2dGyadAa3BvZJ2Omi6thtVWuqMjTFFdM1H_zWAA"
            },
            {
              "name": "x-api-key",
              "value": "pk_live_2e57d59f0802bb0c2e9b373aa7700efd4307a22590d17958aa50a1ac13119c61"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequestTool",
      "typeVersion": 4.3,
      "position": [
        8224,
        928
      ],
      "id": "8c951f53-a652-4f5c-ad91-082329566a72",
      "name": "get_promotions"
    },
    {
      "parameters": {
        "toolDescription": "Validate a promo code. Use when customer provides a promo code to check if it's valid. Returns whether the code is valid and the discount details.",
        "url": "https://xatrtqdgghanwdujyhkq.supabase.co/functions/v1/chatbot-data",
        "sendQuery": true,
        "queryParameters": {
          "parameters": [
            {
              "name": "type",
              "value": "validate_promo"
            },
            {
              "name": "chatbot_id",
              "value": "={{ $('Workflow Configuration').item.json.chatbotId }}"
            },
            {
              "name": "promo_code",
              "value": "={{ $fromAI('promo_code', 'The promo code to validate (e.g., SAVE20, DISCOUNT10)', 'string') }}"
            }
          ]
        },
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhhdHJ0cWRnZ2hhbndkdWp5aGtxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg5NjE1MzEsImV4cCI6MjA3NDUzNzUzMX0.sniz2dGyadAa3BvZJ2Omi6thtVWuqMjTFFdM1H_zWAA"
            },
            {
              "name": "x-api-key",
              "value": "pk_live_2e57d59f0802bb0c2e9b373aa7700efd4307a22590d17958aa50a1ac13119c61"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequestTool",
      "typeVersion": 4.3,
      "position": [
        8320,
        928
      ],
      "id": "validate-promo-tool-id",
      "name": "validate_promo"
    },
    {
      "parameters": {
        "toolDescription": "Get knowledge base files and content. Use when customer asks about company policies, procedures, documentation, or general questions that need reference material. Returns all PDF files with download URLs and all text chunks grouped by file. Share the download_url with customers when they need the actual document.",
        "url": "https://xatrtqdgghanwdujyhkq.supabase.co/functions/v1/chatbot-data",
        "sendQuery": true,
        "queryParameters": {
          "parameters": [
            {
              "name": "type",
              "value": "knowledge"
            },
            {
              "name": "chatbot_id",
              "value": "={{ $('Workflow Configuration').item.json.chatbotId }}"
            }
          ]
        },
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhhdHJ0cWRnZ2hhbndkdWp5aGtxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg5NjE1MzEsImV4cCI6MjA3NDUzNzUzMX0.sniz2dGyadAa3BvZJ2Omi6thtVWuqMjTFFdM1H_zWAA"
            },
            {
              "name": "x-api-key",
              "value": "pk_live_2e57d59f0802bb0c2e9b373aa7700efd4307a22590d17958aa50a1ac13119c61"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequestTool",
      "typeVersion": 4.3,
      "position": [
        8496,
        928
      ],
      "id": "5cb49fe3-29b2-40f2-a7ba-6125af3d5a47",
      "name": "get_knowledge"
    }
  ],
  "pinData": {},
  "connections": {
    "Extract WhatsApp Data": {
      "main": [
        [
          {
            "node": "Workflow Configuration",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Workflow Configuration": {
      "main": [
        [
          {
            "node": "AI Agent",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "AI Agent": {
      "main": [
        [
          {
            "node": "Format for WhatsApp",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "OpenAI Chat Model": {
      "ai_languageModel": [
        [
          {
            "node": "AI Agent",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Format for WhatsApp": {
      "main": [
        [
          {
            "node": "Respond to Webhook",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Webhook": {
      "main": [
        [
          {
            "node": "Switch",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get Audio": {
      "main": [
        [
          {
            "node": "Transcribe a recording",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Transcribe a recording": {
      "main": [
        [
          {
            "node": "Code in JavaScript",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Switch": {
      "main": [
        [
          {
            "node": "Analyze image",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Get Audio",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Code in JavaScript",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Analyze document",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Analyze video",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Analyze image": {
      "main": [
        [
          {
            "node": "Code in JavaScript",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Analyze document": {
      "main": [
        [
          {
            "node": "Code in JavaScript",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Analyze video": {
      "main": [
        [
          {
            "node": "Code in JavaScript",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code in JavaScript": {
      "main": [
        [
          {
            "node": "Extract WhatsApp Data",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Postgres Chat Memory": {
      "ai_memory": [
        [
          {
            "node": "AI Agent",
            "type": "ai_memory",
            "index": 0
          }
        ]
      ]
    },
    "read_webpage": {
      "ai_tool": [
        [
          {
            "node": "AI Agent",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "search_product": {
      "ai_tool": [
        [
          {
            "node": "AI Agent",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "get_promotions": {
      "ai_tool": [
        [
          {
            "node": "AI Agent",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "validate_promo": {
      "ai_tool": [
        [
          {
            "node": "AI Agent",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "get_knowledge": {
      "ai_tool": [
        [
          {
            "node": "AI Agent",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": false,
  "settings": {
    "executionOrder": "v1"
  },
  "versionId": "updated-with-api-tools",
  "meta": {
    "templateCredsSetupCompleted": true,
    "instanceId": "2634913f2f63564c82ce4655d9f40e1dc9c1a1fed88b38602578fc73f31e2a9f"
  },
  "id": "SChJCXGEIZDLgVox",
  "tags": []
}
